// =====================================================================================
// 
//       Filename:  Analyse_Insee.c
// 
//    Description:  
// 
//        Version:  1.0
//        Created:  26.12.2012 14:17:47
//       Revision:  none
//       Compiler:  g++
// 
//         Author:  Loïc BARTOLETTI (), coder@tuxfamily.org
//        Company:  
// 
// =====================================================================================
#include <stdio.h>
#include <stdlib.h>
#include <string.h>

int main(int argc, char *argv[])
{
    int ret = 0;

    if(argc!=2)
    {
        fprintf(stderr, "Usage : %s <nom fichier.DAT>\n", argv[0]);
        ret = -1;
    }
    else
    {
        FILE *fp = NULL;
        if( (fp = fopen(argv[1], "r"))==NULL)
        {
            fprintf(stderr, "Erreur à l'ouverture du fichier.\n");
            ret = -1;
        }
        else
        {
            int nb_ligne = 0;
            char ligne[231];
            typedef struct {
                char district[6];   /* "9001 " */
                char id[4];         /* "2001370   " -> deviendra Id 200 ; Rue 1370 */
                char n_voie[8];
                char id_rue[5];
                char rue[33];
                char obs[81];
                char ch1[6];        /* "00000" */
                char ch2[5];         /* "0000" */
                char champs[13][6];
            } st_insee;

            st_insee insee;
int i;

            while(fgets(ligne, sizeof ligne, fp))
            {
               memset(insee.district, 0, 6);
memset(insee.id, 0, 4);
memset(insee.n_voie, 0, 8);
memset(insee.id_rue, 0, 5);
memset(insee.rue, 0, 33);
memset(insee.obs, 0, 81);
memset(insee.ch1, 0, 6);
memset(insee.ch2, 0, 5);
for (i=0; i< 13; i++)
{
    memset(insee.champs[i], 0, 6);
}
 
                nb_ligne ++;
                size_t pos = 0;
                size_t ncpy = 0;
                

                ncpy = 5;
                strncpy(insee.district, ligne+pos, ncpy);
                insee.district[strchr(insee.district, ' ')-insee.district] = '\0';

                pos += ncpy;
                ncpy = 3;
                strncpy(insee.id, ligne+pos, ncpy);

                pos += ncpy;
                ncpy = 7;
                strncpy(insee.n_voie, ligne+pos, ncpy);
                insee.n_voie[strchr(insee.n_voie, ' ')-insee.n_voie] = '\0';

                pos += ncpy;
                ncpy = 4;
                strncpy(insee.id_rue, ligne+pos, ncpy);
                insee.id_rue[strchr(insee.id_rue, ' ')-insee.id_rue] = '\0';

                pos += ncpy;
                ncpy = 32;
                strncpy(insee.rue, ligne+pos, ncpy);
                insee.rue[strchr(insee.rue, ' ')-insee.rue] = '\0';

                pos += ncpy;
                ncpy = 80;
                strncpy(insee.obs, ligne+pos, ncpy);
                insee.obs[strchr(insee.obs, ' ')-insee.obs] = '\0';   

                pos += ncpy;
                ncpy = 5;
                strncpy(insee.ch1, ligne+pos, ncpy);

                pos += ncpy;
                ncpy = 4;
                strncpy(insee.ch2, ligne+pos, ncpy);
                
                for(i=0; i< 13; i++)
                {
                    pos += ncpy;
                    ncpy = 5;
                    strncpy(insee.champs[i], ligne+pos, ncpy);
                }
                fprintf(stdout, "%s;%s;%s;%s;%s;%s;%s;%s", insee.district, insee.id, insee.n_voie, insee.id_rue, insee.rue, insee.obs, insee.ch1, insee.ch2);
                for(i=0; i< 13; i++)
                {
                    fprintf(stdout, ";%s", insee.champs[i]);
                }
                fprintf(stdout, "\n");
            }
            ret = 1;
        }
        fclose(fp);
        fp = NULL;

    }
    if(ret == 1)
        return EXIT_SUCCESS;
    else
        return EXIT_FAILURE;
}

