#!/usr/bin/env Rscript

ombroT <- function(T_min, T_max, Prec, Year){

par(mar=c(5, 5, 2, 5))

minT <- min(T_min)
maxT <- max(T_max)
maxP <- max(Prec)

if(minT < 0) {
  minY1 <- floor(minT / 5) * 5
  minY2 <- minY1 * 2
  } else  {
  minY2 <- 0
  minY1 <- 0}

if((maxT * 2) > maxP) {
 maxY1 <- ceiling(maxT / 10) * 10
} else {
 maxY1 <- ceiling(maxP / 10) * 5
}

rng <- maxY1 - min(0, minY1)

maxY2 <- minY2 + rng * 2


plot.new()

plot.window(xlim = c(0,14), ylim = c(minY2, maxY2))
for(i in seq(minY2, maxY2, 10)){
abline(h = i, col="grey")
}

mois = c("Janvier", "Février", "Mars", "Avril", "Mai", "Juin", "Juillet", "Août", "Septembre", "Octobre", "Novembre", "Décembre")

par(new=TRUE)

bplt <- barplot(Prec,
        xlim = c(0, 14),
        ylim = c(minY2, maxY2),ylab = "", yaxt ="n",
        width = 1, space = .2,
        col = "darkgoldenrod2",
        names.arg = mois,
        las = 2, add = TRUE)
axis(side = 4, las = 2)
mtext("P (en mm)", side = 4, line =3)

par(new=TRUE)

plot(bplt, T_max,
     xlim = c(0, 14), xaxt = "n", xlab = "",
     ylim = c(minY1, maxY1), ylab = "T (en °C)",
     type = "l", col = "red", lwd = 2, las = 2,
     main=paste("Données météo de l'année", Year, sep=" "))


par(new=TRUE)

plot(bplt, T_min,
     xlim = c(0, 14), xaxt = "n", xlab = "",
     ylim = c(minY1, maxY1), ylab = "T (en °C)",
     type = "l", col = "blue", lwd = 2, las = 2)


}

argv <- commandArgs(TRUE)
meteo <- read.csv2(argv[1])

T_min <- c()
T_max <- c()
Prec <- c()

for (v in unique(format(strptime(meteo$DATEOBS, "%d/%m/%Y"), "%m")))
{
    T_min <- c(T_min, mean(meteo[(format(strptime(meteo$DATEOBS, "%d/%m/%Y"), "%m")==v), c("TN")]/10.0))
    T_max <- c(T_max, mean(meteo[(format(strptime(meteo$DATEOBS, "%d/%m/%Y"), "%m")==v), c("TX")]/10.0))
    Prec <- c(Prec, mean(meteo[(format(strptime(meteo$DATEOBS, "%d/%m/%Y"), "%m")==v), c("RR")]))

}
annee = unique(format(strptime(meteo$DATEOBS, "%d/%m/%Y"), "%Y"))
pdf(file=paste(annee, "pdf", sep="."))

ombroT(T_min = T_min, T_max = T_max, Prec = Prec, Year = annee) 
g <- dev.off()
